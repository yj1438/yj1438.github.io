---
layout: post
title:  浅析 KOA2 的中间件集成
---

# 浅析 KOA2 的中间件集成

## 前言

基本知识接上文 [软件中间件概念简介](/2016/12/28/middleware.html)，其中提到这么一名话：

> “不少新生的、或是老牌的框架系统，也不再像以前那样提供万斤油的功能，只给你一个最基础的平台，剩下的你需要什么自己去写（找）中间件吧。”

咱们今天要说的这个需要各种中间件集成的框架 `KOA2`，就是这样一个典型。
它本身只是一个非常单纯的 `web framework`，在 KOA 首页看到的第一句话就是：

> next generation web framework for node.js

估计里面的 `next` 所指的其中之一就是中间件集成化。

KOA 不像之前传统的一些 server framework：你能想到的功能它都有，你没想到的功能它也有，KOA 真是啥“功能”都没有（它的前身 express 也一样）。
它只是给你提供了一个 web 服务端的平台，有非常完善的 request / response 封装，还有就是今天要重点说的：“规范且开放的中间件集成模式”。

## KOA2 的中间件机制

KOA2 就像是一个空旷的厂房，里面没有任何实际生产的设备，你需要按自己的需求去找到(或自己造)相关的机器设备 --- 中间件，来搭建成一条“流水线”，流水线进入一端就是 `request` 输出的一头就是 `response`。

这也体现了中间件的主要价值：“根据两端进行适合的数据变换”。

![流水线](http://link)

但是，KOA 也有它自己的中间件特征，我们先来看它文档中相关部分：

![doc.gif](/img/middleware/2-2.gif)

但是，KOA 也有它自己的中间件特征，我们先来看它文档中相关部分：

![doc.gif](/img/middleware/2-2.gif)

没错，就是这么一张图，第一次接触KOA(或 express)的人估计要懵逼了，说实话我最开始看的时候也😵了一下：WTF~~~
幸好有个官方的例子，看了一下，又试运行了一下，才知道所以然。

gif 图中主要强调了一个问题：**顺序**。咱们把4个中间件的“执行”顺序写出来：

~~~
1 -> 2 -> 3 -> 4 -> 3 -> 2 -> 1
~~~

是不是有点头绪了。常规的中间件都是遵循着 `从输入到输出` 的队列式集成，多个中间件也是依次执行，典型的流水线模式。
但是 KOA 
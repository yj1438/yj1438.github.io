---
layout: post
title: ssl è¯ä¹¦æ–‡ä»¶èŽ·å–ä¸Ž node çŽ¯å¢ƒä¸‹çš„é…ç½®
---

# sslè¯ä¹¦æ–‡ä»¶èŽ·å–ä¸ŽnodeçŽ¯å¢ƒä¸‹çš„é…ç½®

å‰ä¸¤å¤©ä¸ªäººå°ç«™åŸŸååˆ°æœŸï¼ˆå…¶å®žä¹Ÿæ˜¯å¿˜ç»­äº†ï¼‰ï¼Œæœ‰ç‚¹ç©ºå°±æ”¶æ‹¾äº†ä¸€ä¸‹ï¼Œç”³è¯·äº†æ–°çš„åŸŸåä¸Šçº¿ã€‚
å¸¦æ¥çš„é—®é¢˜æ˜¯ï¼Œç«™ç‚¹ä¸€ç›´ç”¨ httpsï¼Œæ¢åŸŸååŽåŽŸ ssl ç­¾åè¯ä¹¦ä¹Ÿå°±æ— æ•ˆäº†ï¼Œè¿™åˆå¾—å†ç”³è¯·ä¸€ä¸ªã€‚

ä»¥è¿™ä¸ªå¥‘æœºï¼Œå°±æ¥å®Œæ•´çš„è¯´ä¸€ä¸‹ https ç«™ç‚¹ ssl è¯ä¹¦çš„ **ç”Ÿæˆ/èŽ·å–ã€æœåŠ¡å™¨é…ç½®(ä»¥ nodejs ä¸ºä¾‹)** æ–¹æ³•ã€‚

## ssl è¯ä¹¦ç”Ÿæˆ

**ç”Ÿæˆ** å’Œ **èŽ·å–** æ˜¯ä¸¤ç§å¾—åˆ°ç­¾åæ–‡ä»¶æ–¹æ³•ã€‚
è‡ªå·±ç”Ÿæˆçš„ä¸€èˆ¬éƒ½æ˜¯éžæ³•çš„ï¼Œåªç”¨äºŽéžæ­£å¼çŽ¯å¢ƒç­‰ï¼Œè¦æ˜¯çº¿ä¸Šçš„è¯ï¼Œå”¯ä¸€é€”ç»å°±æ˜¯åŽ»æ­£è§„è¯ä¹¦é¢å‘æœºæž„åŽ»ç”³è¯·ï¼Œæœ‰æ—¶ä¹Ÿä¼šé‡åˆ°è‡ªå·±ç”Ÿæˆç­¾åçš„æ—¶å€™ï¼Œä¸‹é¢ç»™å‡ºä¸€ä¸ªå¾ˆç®€å•çš„æ–¹æ³•ã€‚

å¤§è‡´åˆ†ä¸ºä¸‰æ­¥

#### ç”Ÿæˆè‡ªå·±çš„ç§é’¥ å’Œ CSR

> openssl req -new -newkey rsa:2048 -nodes -keyout ca.key -out ca.csr

è¿™ä¸€æ­¥éœ€è¦å¡«å†™ä¸€äº› ca æœºæž„çš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚å›½å®¶ã€åœ°åŒºã€é‚®ç®±ç­‰ç­‰ï¼Œå¤§å®¶å°±æŒ‰æç¤ºä¸€æ­¥ä¸€æ­¥å¾€ä¸‹èµ°å°±OKäº†ã€‚

#### ç”Ÿæˆç­¾å

> openssl x509 -req -days 365 -in ca.csr -signkey ca.key -out cert.crt

#### node æœåŠ¡å™¨é…ç½®

è¿è¡ŒåŽä¼šç”Ÿæˆä¸‰ä¸ªæ–‡ä»¶ï¼Œå®žé™…åªéœ€è¦ä¸¤ä¸ªï¼Œå› ä¸ºæ²¡æœ‰ ca æœºæž„è¯ä¹¦ï¼Œå½“ç„¶ ca æ–‡ä»¶ä¹Ÿå¯ä»¥è‡ªå·±ç”Ÿæˆï¼Œä½†å®žé™…æ²¡æœ‰æ„ä¹‰ï¼Œä¸€èˆ¬ç”¨ä¸¤ä¸ªæ–‡ä»¶æŒ‰ä»¥ä¸‹é…ç½®å°±è¡Œï¼š

~~~javascript
{
    key: fs.readFileSync('SSL/ca.key'),
    cert: fs.readFileSync('SSL/cert.crt')
}
~~~

## ssl è¯ä¹¦èŽ·å–

è¿™ä¸ªè¿‡ç¨‹å› ä¸ºæ˜¯åœ¨ç¬¬ä¸‰æ–¹æœºæž„ä¸Šç”³è¯·ï¼Œæ‰€ä»¥å°±éº»çƒ¦ä¸å°‘ã€‚æˆ‘ä¸ªäººä»Ž Wosign å’Œ Let's encrypt ä¸Šé¢ç”³è¯·è¿‡ï¼Œä¸¤ä¸ªè¿‡ç¨‹å®Œå…¨ä¸åŒï¼Œä¸‹é¢å°±åˆ†åˆ«è¯´ä¸€ä¸‹ã€‚

### Wosign æ²ƒé€š

[æ²ƒé€š](https://www.wosign.com/)æ˜¯å›½å†…æœ€å¤§ ssl ç­¾åé¢å‘æœºæž„ï¼Œä¹‹å‰ä¹ŸæŽ¨å‡ºè¿‡å…è´¹è¯ä¹¦ä¸šåŠ¡ï¼Œä½†æ˜¯åŽ»å¹´åº•åœæ­¢äº†ï¼Œæ®è¯´æ˜¯å› ä¸ºå…è´¹è¯ä¹¦ç”³è¯·çš„å®¡æ ¸ä¸ä¸¥ï¼ŒåŠ å¯†ç®—æ³•è¿˜ç”¨çš„æ˜¯ sha-1ï¼Œé­åˆ° mozila å’Œ google çš„è”åˆæŠµåˆ¶ï¼Œç„¶åŽå°±çŽ©å®Œäº†ã€‚
ä¸è¿‡å®ƒçš„æ”¶è´¹ä¸šåŠ¡è¿˜æ˜¯æœ‰æ•ˆçš„ï¼Œå¤§å®¶å¯ä»¥æ”¾å¿ƒç”³è¯·ã€‚

è¿‡ç¨‹ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œå¡«å†™ä¸€å¼ è¡¨å•å°±è¡Œï¼Œå®ƒåŒæ—¶ä¼šå¯¹ä½ è¦ç”³è¯·çš„åŸŸåè¿›è¡Œæ£€æµ‹ï¼Œæ²¡æœ‰å¤‡æ¡ˆè¦æ±‚ï¼Œç­‰ä¸€åˆ‡æ­¥éª¤èµ°å®Œï¼Œå°±å¯ä»¥é¢†å–ä¸€ä¸ªè£…æœ‰ç­¾åæ–‡ä»¶çš„åŽ‹ç¼©åŒ…ï¼ŒåŽ‹ç¼©åŒ…æ˜¯åŠ å¯†çš„ï¼Œå¯†ç åªèƒ½äººä»Ž wosign é¢†å–ä¸€æ¬¡ï¼Œæ‰“å¼€åŽä¸€å®šå¦¥å–„ä¿ç®¡ã€‚

é‡Œé¢ä¸€æ­¤æ–‡ä»¶å¤¹æŒ‰å¸¸è§æœåŠ¡å™¨çš„åˆ†ç±»ï¼Œå®žé™…å†…å®¹éƒ½ä¸€æ ·ï¼Œæ–¹ä¾¿ç”¨æˆ·ä¸€ä¸‹æ‰¾åˆ°ï¼Œä½†æ˜¯æ²¡æœ‰ nodejs çš„ï¼Œå®žé™…ç”¨ apache çš„é‚£å¥—è¯ä¹¦å°±å¯ä»¥äº†ï¼Œå¦‚ä¸‹ï¼š

~~~javascript
// xxx æ˜¯ä½ ç”³è¯·çš„åŸŸåï¼Œæ³¨æ„å‰çš„æ–‡ä»¶åºå·å°±è¡Œ
{
    key: fs.readFileSync('3_xxx.key'),          
    cert: fs.readFileSync('2_xxx.crt'),
    ca: fs.readFileSync('1_root_bundle.crt'),
}
~~~

### Let's encrypt

[Let's encrypt](https://letsencrypt.org/) çŽ°åœ¨å½±å“åŠ›è¶Šæ¥è¶Šå¤§ï¼Œæ˜¯ mozila å’Œ google åˆåŠ›ä¸ºäº†æŽ¨å¹¿ https è€Œæ”¯æŒçš„æŠ€æœ¯æä¾›ç«™ç‚¹ï¼ˆçœ‹äº†ä¸€çœ¼æ²ƒé€šðŸ’¡~ï¼Ÿï¼‰ã€‚
åªæä¾›å…è´¹çš„è¯ä¹¦ï¼Œä½†ä½ å¯åˆ«æƒ³ç®€å•äº†ï¼Œgoogle æŽ¨çš„ä¸œè¥¿æŠ€æœ¯å«é‡éƒ½ä¸ä½Žã€‚
ç¬”è€…åˆšä¸€ä¸ŠåŽ»ä¹Ÿæ²¡ååº”è¿‡æ¥ï¼Œè€Œä¸”å¸‚é¢ä¸Šç›¸å…³èµ„æ–™å¾ˆå°‘ï¼Œç¡¬ç€å¤´çš®çœ‹äº†ä¸€ä¸ªå¤šå°æ—¶çš„è‹±æ–‡æ–‡æ¡£æ‰å¼€å§‹ä¸‹æ‰‹æžèµ·ã€‚ðŸ˜«

å®ƒçš„èŽ·å–æ–¹å¼ä¸åƒä¼ ç»Ÿç”³è¯·å®¡æ ¸é‚£æ ·ä¸­è§„ä¸­çŸ©ï¼Œä¸€åˆ‡é€šè¿‡è®¾è®¡å¥½çš„å‘½ä»¤å’Œä»£ç æžå®šï¼Œä¸­é—´æ²¡æœ‰äººå·¥å¹²é¢„ã€‚
ç­¾åæ–‡ä»¶åœ¨èŽ·å–è¿‡ç¨‹ä¸­éƒ½æ˜¯éšå¼çš„ï¼Œç›´æŽ¥ç”Ÿæˆåœ¨ä½ çš„æœåŠ¡å™¨ä¸Šï¼Œä»Žé¢è§£å†³äº†ç­¾ååœ¨ç½‘ç»œä¸Šä¼ è¾“çš„å®‰å…¨é—®é¢˜ï¼Œè€Œä¸”å¯¹ä¸€äº›å¸¸ç”¨çš„æœåŠ¡å™¨ï¼Œå¦‚ nginxï¼Œå®ƒè¿˜ä¼šè‡ªåŠ¨è¯†åˆ«ã€è‡ªåŠ¨éƒ¨ç½²ç­¾åï¼Œéžå¸¸è…»å®³ã€‚
ä½†æ˜¯æ²¡æœ‰ nodejs çš„ã€‚ã€‚ã€‚

å®žé™…è¿‡ç¨‹ä¸­è‡ªåŠ¨åŒ–ç¨‹åº¦éžå¸¸é«˜ï¼Œéœ€è¦æ“ä½œçš„æ­¥éª¤ä¹Ÿå¾ˆå°‘ï¼Œä½†å‰ææ˜¯è¦å¼„æ˜Žç™½æ€Žä¹ˆå›žäº‹ï¼Œå¦åˆ™ä¸‹ä¸äº†æ‰‹ã€‚ã€‚ã€‚ä»¥ centOS_7 ä¸ºä¾‹ï¼Œè¯´ä¸€ä¸‹èŽ·å–è¿‡ç¨‹ï¼Œä¹Ÿæ˜¯æœ¬æ–‡çš„é‡ç‚¹å†…å®¹ã€‚

#### å®‰è£… certbot

certbot æ˜¯è‡ªåŠ¨èŽ·å–è¯ä¹¦çš„ä¸€ä¸ªå‘½ä»¤å·¥å…·åŒ…ï¼Œä¹Ÿæ˜¯æ‰€æœ‰è¿‡ç¨‹çš„å‰æï¼Œå®‰è£…è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œç”¨ yum ï¼š

> $ sudo yum install certbot

> æ³¨ï¼šå¦‚æžœæ²¡æœ‰æ­¤å·¥å…·ï¼Œå…ˆè¿è¡Œä¸€ä¸‹ï¼š
> $ yum install epel-release

#### è‡ªå·±ç«™ç‚¹çš„å‡†å¤‡

* ä¿è¯è‡ªå·±ç«™å†…å¯¹å¤–è®¿é—®è‰¯å¥½
* æä¾›ä¸€ä¸ªç±»ä¼¼é™æ€èµ„æºç›®å½•çš„å¯¹å¤–å¯è®¿é—®ç›®å½•ï¼Œå¦‚ï¼š/usr/www/static/ï¼Œä½¿å¾—å¯¹å¤–é“¾æŽ¥ www.your_web.com/aaa/bbb.js å¯ä»¥è®¿é—®åˆ° /usr/www/static/aaa/bbb.js æ–‡ä»¶

#### å‘½ä»¤è¡ŒèŽ·å–

ä»¥ä¸Šéƒ½å‡†å¤‡å¥½åŽï¼Œå°±å¼€å§‹æ­£å¼èŽ·å–äº†ã€‚è¿è¡Œï¼š

> $ certbot certonly

~~~shell
-------------------------------------------------------------------------------
1: Place files in webroot directory (webroot)
2: Spin up a temporary webserver (standalone)
-------------------------------------------------------------------------------
~~~

ä¼šå‡ºçŽ°ä¸¤ç§èŽ·å–æ–¹å¼çš„é€‰æ‹©ï¼Œæˆ‘å…ˆçš„æ˜¯ç¬¬ä¸€ç§ï¼Œæ„Ÿè§‰æ›´æ–¹ä¾¿ä¸€äº›ã€‚

~~~shell
Please enter in your domain name(s) (comma and/or space separated)  (Enter 'c' to cancel):
~~~

è¾“å…¥ä½ çš„ç«™ç‚¹åŸŸåï¼Œç”¨é€—å·/ç©ºæ ¼åˆ†éš”ï¼š æ¯”å¦‚`xxx.com, www.xxx.com`

~~~shell
-------------------------------------------------------------------------------
1: Enter a new webroot
-------------------------------------------------------------------------------
~~~

åˆ°äº†è¿™ä¸€æ­¥ç¨éº»çƒ¦ç‚¹ï¼Œå®ƒæ˜¯è®©ä½ è¾“å…¥æœ¬åœ°ç«™ç‚¹ç›®å½•çš„ç»å¯¹è·¯å¾„ï¼Œä¸è¿‡ä¸ä¸€å®šå°±æ˜¯ä½ æƒ³å¾—è¿™æ ·ã€‚
å®ƒçš„ç›®çš„æ˜¯è¦æ£€æµ‹ä½ å¯¹è¯¥ç½‘ç«™çš„æŽ§åˆ¶æƒï¼Œè¦åœ¨ä½ è¾“å…¥çš„ç›®å½•é‡Œæ”¾ç½®é™æ€æ ¡éªŒæ–‡ä»¶ï¼Œç„¶åŽè¿›è¡Œè¿œç¨‹æ ¡éªŒï¼Œ
æ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠç½‘ç«™çš„é™æ€èµ„æºæ–‡ä»¶ç›®å½•ç»™å®ƒï¼Œè¦æ±‚å†å›žåŽ»çœ‹ **è‡ªå·±ç«™ç‚¹çš„å‡†å¤‡** é‚£ä¸€èŠ‚ã€‚

å¦‚æˆ‘ä»¬è¾“å…¥ï¼š `/usr/www/static` å°±è¡Œã€‚

å¦‚æžœä½ ä¹‹å‰ç»‘å®šåªæ˜¯ä¸€ä¸ªåŸŸåï¼Œåˆ°è¿™å°±ç»“æŸäº†ï¼Œå¦‚æžœå¤šä¸ªåŸŸåçš„è¯ï¼Œä¼šæ˜¾ç¤ºï¼š 

~~~shell
Select the webroot for www.xxx.ml:
-------------------------------------------------------------------------------
1: Enter a new webroot
2: /root/www/static
-------------------------------------------------------------------------------
~~~

å¦‚æžœç›®å½•ä¸€è‡´ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æŽ¥ 2ã€‚

#### ç­¾åæ–‡ä»¶çš„ä½¿ç”¨

ä¸Šè¿°è¿‡ç¨‹æˆåŠŸåŽï¼Œä¼šæç¤ºï¼š

~~~shell
Waiting for verification...
Cleaning up challenges
Generating key (2048 bits): /etc/letsencrypt/keys/0000_key-certbot.pem
Creating CSR: /etc/letsencrypt/csr/0000_csr-certbot.pem

IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at
   /etc/letsencrypt/live/xxx.ml/fullchain.pem. Your cert will
   expire on 2017-06-07. To obtain a new or tweaked version of this
   certificate in the future, simply run certbot again. To
   non-interactively renew *all* of your certificates, run "certbot
   renew"
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le
~~~

åŒæ—¶åœ¨ `/etc/letsencrypt/` è·¯å¾„ä¸‹ç”Ÿæˆä¸€ç»„ç­¾åæ–‡ä»¶ï¼š

~~~shell
accounts  archive  csr  keys  live  renewal
~~~

å…¶ä¸­æˆ‘ä»¬éœ€è¦çš„æ˜¯ live é‚£ç»„ï¼Œé‡Œé¢æœ‰ä½ åŸŸåä¸€è‡´çš„ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼ŒåŒ…å«å››ä¸ªç­¾åæ–‡ä»¶ï¼š

~~~shell
cert.pem  chain.pem  fullchain.pem  privkey.pem
~~~

å’Œ nodejs https çš„å¯¹åº”å…³ç³»æ˜¯ï¼š

~~~javascript
// xxx æ˜¯ä½ ç”³è¯·çš„åŸŸåï¼Œæ³¨æ„å‰çš„æ–‡ä»¶åºå·å°±è¡Œ
{
    key: fs.readFileSync('privkey.pem'),          
    cert: fs.readFileSync('cert.pem'),
    ca: fs.readFileSync('fullchain.pem'),
}
~~~

é…ç½®å¥½ï¼Œé‡å¯æœåŠ¡å™¨ï¼Œå†æ‰“å¼€ä½ çš„ç«™ç‚¹ï¼Œæ˜¯ä¸æ˜¯å·²ç»å˜æˆï¼š

![/img/brower_https.png](/img/brower_https.png)

è¿‡ç¨‹çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œå‰ææ˜¯ä½ çŸ¥é“è¿™ä¸ªè¿‡ç¨‹ã€‚ä»¥åŽè¯ä¹¦å°±å®ƒäº†ã€‚

#### åŽç»­å»¶é•¿è¯ä¹¦æœ‰æ•ˆæœŸ

èƒ½è¿‡ä»¥ä¸Šæ–¹æ³•é¡ºåˆ©èŽ·å–çš„è¯ä¹¦æœ‰æ•ˆæœŸåªæœ‰ä¸‰ä¸ªæœˆï¼Œå¿«åˆ°æœŸçš„æ—¶å€™è®°å¾—åŽ»ç»­æœŸï¼Œè¿™ä¸ªä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦æ‰§è¡Œï¼š

~~~bash
$ certbot renew
~~~

ç„¶åŽæŒ‰ç…§æç¤ºå¾€ä¸‹èµ°å‡ æ­¥å°±å¯ä»¥äº†ã€‚è¿™æ ·å°±åˆæœ‰ä¸‰ä¸ªæœˆæœ‰æ•ˆæœŸäº†ã€‚

---

> å¼•ç”¨ï¼š  
> https://certbot.eff.org/docs/using.html#webroot  
> https://certbot.eff.org/#centosrhel7-other  
> https://community.letsencrypt.org/t/how-to-get-crt-and-key-files-from-i-just-have-pem-files/7348



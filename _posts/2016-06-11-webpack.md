---
layout: post
title: webpack 开发环境/生产环境打包配置
---

# 完整的 webpack 开发环境与生产环境打包配置

webpack 这一打包神器想必大家早已使用了，不过 webpack 那差劲的官方文档真是搞晕不少入门者吧。  
在这里，分享一套完整的 WEBPACK 打包配置，笔者已经在实际项目中使用了半年多，不断改进，没有什么问题。  
希望对大家有所帮助。

## 开发环境

### 特点

* hot-server 支持 liveload 即写即生效；
* js 和 css 分离，保证打包文件的整洁，最终会生成 `/app.js` 和 `/app.css`两个文件，文件名可以按自己情况随意改；
* 默认支持 LESS ，其它的如 SASS 自己可以改；
* 小于 8KB 图片的图片会打进 CSS 中，其它按 `[name].[ext]` 的文件名进行输出。

~~~javascript
/**
 * 开发环境 dev-server 构建方法
 */
'use strict';

const webpack = require('webpack');
const path = require('path');
const buildPath = path.resolve(__dirname, 'build');
const nodeModulesPath = path.resolve(__dirname, 'node_modules');
const TransferWebpackPlugin = require('transfer-webpack-plugin');
const ExtractTextPlugin = require('extract-text-webpack-plugin');

/**
 * 需要构建项目的入口文件
 * 想对于当前目录
 */
//===========================================
const enterFile = 'src/app/index.jsx';
//===========================================

module.exports = {
    //总入口文件
    entry: {
        // polyfill: 'babel-polyfill',
        server: ['webpack/hot/dev-server', 'webpack/hot/only-dev-server'],
        app: path.join(__dirname, enterFile)
    },
    //入口文件配置解析类型
    resolve: {
        //默认打包文件
        root: path.resolve('src'),
        extensions: ["", ".js", ".jsx"],
        modulesDirectories: ['node_modules'] //(Default Settings)
        //node_modules: ["web_modules", "node_modules"]  (Default Settings)
    },
    //server 配置
    devServer: {
        contentBase: 'www', //发布目录
        devtool: 'eval',
        hot: true, //Live-reload
        inline: true,
        host: '0.0.0.0',
        port: 9080 //Port Number
    },
    devtool: 'eval',
    output: {
        path: buildPath, //输出根目录
        publicPath: '',     // 引用资源文件的base路径
        filename: './[name].js'  //输出文件名
    },
    plugins: [
        //Enables Hot Modules Replacement
        new webpack.HotModuleReplacementPlugin(),
        //Allows error warnings but does not stop compiling. Will remove when eslint is added
        new webpack.NoErrorsPlugin(),
        //移动文件，如果发布目录和编辑目录不一致时，可以配置此项将编辑的 www 内容文件转移到发布目录
        /*
        new TransferWebpackPlugin([
            {
                from: 'www'
            }
        ], path.resolve(__dirname, "")),
        */
        //输出 CSS 文件
        new ExtractTextPlugin(".[name].css")
    ],
    module: {
        //构建前置加载器
        preLoaders: [
            {
                //Eslint loader
                test: /\.(js|jsx)$/,
                loader: 'eslint-loader',
                include: [path.resolve(__dirname, "src/app")],
                exclude: [nodeModulesPath]
            }
        ],
        loaders: [
            /*
             * 图片打包，小于 8KB 的打进 CSS 文件
             */
            { 
                test: /\.jpe?g$|\.gif$|\.png$/i,
                loader: "url-loader?limit=8192&name=./[name].[ext]"
            },
            //外置样式打包
            {
                test: /\.css/,
                loader: ExtractTextPlugin.extract("style-loader", "css-loader!autoprefixer-loader")
            },
            {
                test: /\.less$/,
                //?{browsers:['> 1%', last 2 version', 'Android >= 4.0']}
                loader: ExtractTextPlugin.extract("style-loader", "css-loader!autoprefixer-loader!less-loader")
            },
            {
                //React-hot loader and
                test: /\.(js|jsx)$/,
                /*
                 * babel 设置query后就不用 .babelrc 文件了
                 */
                loaders: ['react-hot', 'babel?presets[]=react,presets[]=es2015,presets[]=stage-0'], //react-hot is like browser sync and babel loads jsx and es6-7
                include: [path.join(__dirname, '/src')],
                exclude: function (path) {
                    var isNpmModule = !!path.match(/node_modules/);
                    return isNpmModule;
                },
                /*
                exclude: [
                    nodeModulesPath
                ],
                */
            }
        ]
    },
    //eslint config 文件配置路径
    eslint: {
        configFile: '.eslintrc.json'
    }
};

~~~

## 生产环境

因为在生产环中涉及到了 DllReferance，这里有两个配置文件，一个主业务打包，一个公共模块打包。  
默认没有打开，如果你需要用到这个优化插件的话，就需要两个配置文件，打包两次。注释里有详细介绍。

### 特点

* 支持最新的 ES6/7 + reactjs 语法；
* 自定义了入口文件的命令参数 `--path`，后面加入口文件的路径，相对于 `src`，如 `webpack --config webpack.product.config.js --progress --color --path app/index.jsx`，如此可在打包命令中动态设定入口文件，你还可以自己写一个脚本，更加精简打包命令；
* js 和 css 分离，保证打包文件的整洁，最终会生成 `/app.js` 和 `/app.css`两个文件，文件名可以按自己情况随意改；
* 资源文件压缩 （废话～）；
* 图片打包先压缩，压缩后小于 8KB 的图片直接打进 CSS，其它图片输出到目标文件夹，如果感觉到压缩图片太慢，可以去掉 `!img-loader?minimize`；
* 默认支持 LESS ，其它的如 SASS 自己可以改；
* 小于8KB图片的图片会打进 CSS 中，其它按 `[name].[ext]` 的文件名进行输出。


### 业务代码 webpack 打包

~~~javascript
/**
 * 生产环境发布方法
 */
'use strict';
const webpack = require('webpack');
const path = require('path');
const ExtractTextPlugin = require('extract-text-webpack-plugin');

//获取入口文件
const argv = process.argv,
    index = argv.indexOf('--path');

if (index === -1 || !argv[index + 1]) {
    console.log('缺少入口文件，请检查执行命令');
    return;
}

const nodeModulesPath = path.resolve(__dirname, 'node_modules');
const projectName = argv[index + 1],
    projectPathArr = projectName.split('/');

console.log(projectName);

const userRoot = path.resolve(__dirname),
    buildPath = path.join('dist/', projectPathArr[0]); 

module.exports = {
    /*
     * 要进行打包的入口文件
     * 如果是要强力增强兼容性，比如要在低版本桌面浏览器上用，就加上'babel-polyfill'，把整个babel环境都打进去
     */
    entry: {
        app: path.join(__dirname, '/src', projectName),
        react: ['react', 'react-dom'],    //详见 webpack.DllReferencePlugin 说明
        router: ['react-router']
    },
    resolve: {
        //默认打包文件
        root: path.resolve('src'),
        extensions: ["", ".js", ".jsx"],
        modulesDirectories: ['node_modules'] //(Default Settings)
    },
    /*
     * Render source-map file for final build
     * 选择cheap-source-map，这个比 source-map 快不少
     */
    //devtool: 'cheap-source-map',
    output: {
        path: path.join(userRoot, buildPath), //输出路径
        publicPath: '',     //src 的 base 路径
        filename: './[name].js' //输出的文件名
    },
    plugins: [
        /*
         * 将打包环境定为生产环境
         */
        new webpack.DefinePlugin({
            'process.env': {
                'NODE_ENV': '"production"'
                }
            }),

        /*
         * 将公共模块分离出去
         */
        new webpack.optimize.CommonsChunkPlugin({
            name: ['react','router'],
            minChunks: Infinity
        }),
        
        /*
         * 打包时排除react模块
         * 极大的提高打包速度
         *  这个和上面的那个 webpack.optimize.CommonsChunkPlugin 本质上是一致的，
         *  更先进的是彻底将 react 的核心包排出了全部打包过程
         *  所以打包时候会大幅的减少，一般会快 7s
         *  代价只是需要更新核心包时，手动执行一遍相关命令
         *  还会整体变大50K，左右，不知道是怎么回事
         */
        //new webpack.DllReferencePlugin({
        //    context: __dirname,
        //    manifest: require(path.join(userRoot, 'dist/dll', 'verdor-manifest.json'))
        //}),
        
        new webpack.optimize.DedupePlugin(),

        /*
         * 压缩
         */
        new webpack.optimize.UglifyJsPlugin({
            compress: {
                //supresses warnings, usually from module minification
                warnings: false
            }
        }),
        
        //只报出错误或警告，但不会终止编译，建议如果是开发环境可以把这一项去掉
        new webpack.NoErrorsPlugin(),
        
        //输出 CSS 文件
        new ExtractTextPlugin('./[name].css')
    ],
    module: {
        //eslint 
        preLoaders: [
            {
                test: /\.(js|jsx)$/,
                loader: 'eslint-loader',
                include: [path.resolve(__dirname, "src/app")],
                exclude: [nodeModulesPath]
            }
        ],
        loaders: [
            //"file-loader?name=img/[hash:8].[name].[ext]",
            //压缩图片，不过这个在图片多的情况下压缩很慢,
            { 
                test: /\.(jpe?g|png|gif|svg)$/i,
                loader: "url-loader?limit=8192&name=./[name].[ext]!img-loader?minimize"
            },
            //内联样式
            /*
            { test: /\.css$/, loader: 'style-loader!css-loader!autoprefixer-loader' },
            { test: /\.less$/, loader: 'style-loader!css-loader!autoprefixer-loader!less-loader' },
            */
            //外置样式打包
            {
                test: /\.css/,
                loader: ExtractTextPlugin.extract("style-loader", "css-loader!autoprefixer-loader?{browsers:['> 1%', 'Android >= 4.0']}")
            },
            {
                test: /\.less$/,
                //?{browsers:['> 1%', 'last 2 version', 'Android >= 4.0']}
                loader: ExtractTextPlugin.extract("style-loader", "css-loader!autoprefixer-loader?{browsers:['> 1%', 'Android >= 4.0']}!less-loader")
            },
            /**
             * js/jsx 编译
             * @query 编译参数，这里配置后，不再需要.babelrc文件
             *      presets:
             *          es2015 ES6
             *          stage-0 ES7
             *          react JSX
             */
            {
                test: /\.(js|jsx)$/,
                loader: 'babel-loader',
                include: [path.join(__dirname, '/src')],
                exclude: function (path) {
                    var isNpmModule = !!path.match(/node_modules/);
                    return isNpmModule;
                },
                /*
                exclude: [
                    nodeModulesPath
                ],
                */
                query: {
                    // plugins: ['transform-runtime'],
                    presets: ['es2015', 'stage-0', 'react']
                }
            }
        ]
    },
    /*
     * img-loader
     * img-loader?minimize 对应的压缩参数
     */
    imagemin: {
        gifsicle: { interlaced: false },
        jpegtran: {
            progressive: true,
            arithmetic: false
        },
        optipng: { optimizationLevel: 7 },
        pngquant: {
            floyd: 0.5,
            speed: 2
        },
        svgo: {
            plugins: [
                { removeTitle: true },
                { convertPathData: false }
            ]
        }
    },
    //Eslint config
    eslint: {
        configFile: '.eslintrc.json' //Rules for eslint
    }
};

~~~

### DllReferencePlugin 配置文件(可选项)

如果你开启了 `DllReferencePlugin`，则需要此打包配置。如果不用 DllReferencePlugin 这个可以忽略。  
注意：打开 `DllReferencePlugin` 后，构建速度是快了不少，重复模块不再需要打包，复用性好，但是总体大小变大了 50bk。

~~~javascript

const path = require('path');
const webpack = require('webpack');

const userRoot = path.resolve(__dirname),
    buildPath = path.join('dist/', 'dll'); 

/**
 *
 */
module.exports = {
    entry: {
        verdor: ['react', 'react-dom']
    },
    output: {
        path: path.join(userRoot, buildPath), //输出路径
        filename: '[name].dll.js',
        library: '[name]_library'
    },
    plugins: [
        /*
         * 将打包环境定为生产环境
         */
        new webpack.DefinePlugin({
            'process.env': {
                'NODE_ENV': '"production"'
            }
        }),
        
        new webpack.optimize.DedupePlugin(),

        new webpack.DllPlugin({
            /*
             * path  
             * 定义 manifest 文件生成的位置
             * [name] 的部分由 entry 的名字替换
             */
            path: path.join(userRoot, buildPath, '[name]-manifest.json'),
            /*
             * name
             * dll bundle 输出到哪个全局变更上
             * 和 output.library 一样即可
             */
            name: '[name]_library'
        }),
        /*
         * 压缩
         */
        new webpack.optimize.UglifyJsPlugin({
            compress: {
                //supresses warnings, usually from module minification
                warnings: false
            }
        })
    ]
}

~~~
---
layout: post
title: 页面显存占用分析
published: false
categories: 技术文章
tags: css
---

h5 页面内存消耗，尤其在移动端是一个很值得注意的问题。移动端应用切换和启动频繁，内存向来是紧俏资源，内存不足轻者页面卡死、渲染出问题，重者直接白/黑屏、整个应用 crash。
所以在页面开发中，要尽量避免不发必要的内存占用。

> 请先看文章：css 动画分析和优化建议1

## 内存用哪了

页面渲染过程中，CPU 和 GPU 占用内存主要是用来存放每个 layer 栅格化后图像，除此之外，GPU 还会占用一定的“显存”来对每一个图层的图像进行缓存，以便在后来的渲染中进行复用。

大家第一反应应该是页面中使用的大量图片资源，这个没错，不过可不只这些。

举个例子，
我们在页面中画一个 300 * 200 的矩形，背景设为红色 `background: #ff0000;`。
再加载一个同样是 300 * 200 的图片，也是纯红色。

你应该会想，这种情况用背景色就 ok，还能减少一个图片，内存使用也会少，这个是正确的，会少近 1kb 的资源请求量。但我们这里说的是渲染用的内存，也就是显存使用量。

页面在渲染过程中，会生成象素化的位图图层，比如上面的 300 * 200，它占用的内存就是 `300 * 300 * 4 = 360,000 bytes` 大约是 350+KB，乘以的这个 `4` 就是记录每个像素需要的字节数，`R、G、B、a` 每个正好是 8bit。当然，在这里，使用图片和背景色都占用这么多。

在实际移动端页面中，受高密度屏幕影响，内存占用会翻几倍，比如 iphone 6/7/8 单纯 root layer 只一屏的显存占用就是 `750 * 1334 * 4 = 4,002,000 bytes`。
按两屏长的页面 + 6 个 layer (这个在实际中已经很少了)算，那就是大概是 48MB 显存。
这只是 GPU Composite 使用的显存，除此外还有 JS 运行需要的内存量、解析资源占用的内存(这个在图片较多的页面占用量较大)

## 内存回收

当一个页面有 transform 动效时，细心的




